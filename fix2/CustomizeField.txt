const [uploadedFiles, setUploadedFiles] = useState({});

const getBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

const handleFileChange = (fieldName, info) => {
  const { fileList } = info;
  
  // ✅ Xử lý giống avatar
  if (fileList.length > 0) {
    const lastFile = fileList[fileList.length - 1];
    
    if (lastFile.originFileObj) {
      getBase64(lastFile.originFileObj).then((base64) => {
        // Lưu base64 vào state
        setUploadedFiles(prev => ({
          ...prev,
          [fieldName]: base64
        }));
        
        // Update form value
        form.setFieldsValue({
          customField: {
            ...form.getFieldValue('customField'),
            [fieldName]: base64
          }
        });
      });
    }
  } else {
    // Clear khi xóa file
    setUploadedFiles(prev => {
      const newState = { ...prev };
      delete newState[fieldName];
      return newState;
    });
    
    form.setFieldsValue({
      customField: {
        ...form.getFieldValue('customField'),
        [fieldName]: null
      }
    });
  }
};

// Render field
if (field.field_format === 'attachment') {
  return (
    <Form.Item
      label={field.name}
      name={['customField', field.name]}
      rules={[
        {
          required: field.is_required === 1,
          message: formatMessage({
            id: 'field.required',
            defaultMessage: 'This field is required',
          }),
        },
      ]}
    >
      <Upload
        name={field.name}
        listType="picture-card"
        showUploadList={false}
        maxCount={field.multiple === 1 ? 10 : 1}
        beforeUpload={(file) => {
          const allowedExtensions = field.format_store?.extensions_allowed
            ?.split(',')
            .map((ext) => ext.trim());
          
          if (allowedExtensions && allowedExtensions.length > 0) {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(`.${fileExtension}`) && !allowedExtensions.includes(fileExtension)) {
              message.error(
                formatMessage({
                  id: 'field.invalid.extension',
                  defaultMessage: `Invalid file type. Allowed extensions: ${allowedExtensions.join(', ')}`,
                })
              );
              return Upload.LIST_IGNORE;
            }
          }
          return false; // Không auto upload
        }}
        onChange={(info) => handleFileChange(field.name, info)}
      >
        {uploadedFiles[field.name] ? (
          <img
            src={uploadedFiles[field.name]}
            alt="preview"
            style={{ width: '100%', height: '100%', objectFit: 'cover' }}
          />
        ) : (
          <div>
            <PlusOutlined />
            <div style={{ marginTop: 8 }}>Upload</div>
          </div>
        )}
      </Upload>
    </Form.Item>
  );
}