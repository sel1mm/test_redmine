// ✅ Helper function convert file to base64
const fileToBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

// Trong mapFormData
else if (key === 'customField') {
  const customFieldObj = values.customField || {};
  
  // ✅ Process all fields including files
  const processedFields = await Promise.all(
    Object.entries(customFieldObj)
      .filter(([_, v]) => v !== undefined && v !== null && v !== '')
      .map(async ([name, value]) => {
        // Xử lý date
        if (moment.isMoment(value)) {
          return { name, value: value.format('YYYY-MM-DD') };
        }
        
        // Xử lý boolean
        if (typeof value === 'boolean') {
          return { name, value: value ? '1' : '0' };
        }
        
        // Xử lý number
        if (typeof value === 'number') {
          return { name, value: String(value) };
        }
        
        // ✅ Xử lý fileList - Convert to base64
        if (Array.isArray(value) && value.length > 0 && value[0]?.originFileObj) {
          const filesData = await Promise.all(
            value.map(async (file) => {
              // File đã tồn tại (có url/path)
              if (file.url && !file.originFileObj) {
                return {
                  name: file.name,
                  path: file.path,
                  url: file.url,
                  size: file.size,
                };
              }
              
              // File mới upload - convert to base64
              if (file.originFileObj) {
                const base64 = await fileToBase64(file.originFileObj);
                return {
                  name: file.name,
                  data: base64, // Base64 string
                  size: file.size,
                  type: file.type,
                };
              }
              
              return null;
            })
          );
          
          // Filter null values
          const validFiles = filesData.filter(f => f !== null);
          
          // Single file vs multiple files
          return { 
            name, 
            value: validFiles.length === 1 ? validFiles[0] : validFiles 
          };
        }
        
        // Các giá trị khác
        return { name, value: String(value) };
      })
  );
  
  if (processedFields.length > 0) {
    formData.append('customField', JSON.stringify(processedFields));
  }
}