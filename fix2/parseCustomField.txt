const parseCustomField = (req, res, next) => {
  try {
    if (req.body.customField) {
      const customFieldArray = JSON.parse(req.body.customField);
      const fileMetadata = req.body.fileMetadata ? JSON.parse(req.body.fileMetadata) : [];
      
      // Map uploaded files
      if (req.files && req.files.length > 0) {
        customFieldArray.forEach(field => {
          if (field.value === '__FILE_METADATA__') {
            const fieldFiles = fileMetadata
              .filter(meta => meta.fieldName === field.name && !meta.existing)
              .map((meta, idx) => ({
                name: req.files[idx].originalname,
                filename: req.files[idx].filename,
                path: req.files[idx].path,
                size: req.files[idx].size,
                mimetype: req.files[idx].mimetype,
              }));
            
            const existingFiles = fileMetadata.filter(meta => meta.fieldName === field.name && meta.existing);
            const allFiles = [...existingFiles, ...fieldFiles];
            
            field.value = allFiles.length === 1 ? allFiles[0] : allFiles;
            delete field.fileCount;
          }
        });
      }
      
      req.body.customField = customFieldArray;
    }
    next();
  } catch (e) {
    next(e);
  }
};