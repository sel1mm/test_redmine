const path = require('path');
const { getPublicPath } = require('../utils/path.util');

const parseCustomField = (req, res, next) => {
  // 1️⃣ Parse JSON như hiện tại
  if (req.body.customField && typeof req.body.customField === 'string') {
    try {
      req.body.customField = JSON.parse(req.body.customField);
    } catch (e) {
      return res.status(400).json({
        message: 'customField must be valid JSON',
      });
    }
  }

  // 2️⃣ Nếu không có customField hoặc không phải array → skip
  if (!Array.isArray(req.body.customField)) {
    return next();
  }

  // 3️⃣ Nếu có file upload cho customField
  if (req.files && req.files.customFieldFiles) {
    req.files.customFieldFiles.forEach((file) => {
      // tìm field tương ứng theo originalname
      const field = req.body.customField.find(
        (f) => f.value === file.originalname
      );

      if (field) {
        // map sang public path (giống avatar)
        field.value = path.join(
          getPublicPath('uploads'),
          file.filename
        );
      }
    });
  }

  next();
};

module.exports = { parseCustomField };
