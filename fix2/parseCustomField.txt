const parseCustomField = (req, res, next) => {
  if (req.body.customField && typeof req.body.customField === 'string') {
    try {
      const customFieldArray = JSON.parse(req.body.customField);
      
      // ✅ Xử lý files (base64) nếu có
      customFieldArray.forEach(field => {
        const value = field.value;
        
        // Check nếu là file data (có property 'data' với base64)
        if (value && typeof value === 'object') {
          // Single file with base64
          if (value.data && value.data.startsWith('data:')) {
            const saved = saveBase64File(value);
            field.value = saved;
          }
          // Multiple files
          else if (Array.isArray(value)) {
            field.value = value.map(file => {
              if (file.data && file.data.startsWith('data:')) {
                return saveBase64File(file);
              }
              // File đã tồn tại, giữ nguyên
              return file;
            });
          }
        }
      });
      
      req.body.customField = customFieldArray;
      
    } catch (e) {
      console.error('parseCustomField error:', e);
      return res.status(400).json({
        message: 'customField must be valid JSON',
        error: e.message,
      });
    }
  }
  next();
};

// ✅ Helper function save base64 to file
const saveBase64File = (fileData) => {
  const fs = require('fs');
  const path = require('path');
  
  // Extract base64 data
  const matches = fileData.data.match(/^data:(.+);base64,(.+)$/);
  if (!matches) return fileData;
  
  const mimeType = matches[1];
  const base64Data = matches[2];
  const buffer = Buffer.from(base64Data, 'base64');
  
  // Generate filename
  const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
  const ext = mimeType.split('/')[1];
  const filename = `${uniqueSuffix}-${fileData.name}`;
  
  // Save path
  const uploadDir = path.resolve(config.upload.customField || config.upload.employee);
  if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
  }
  
  const filePath = path.join(uploadDir, filename);
  fs.writeFileSync(filePath, buffer);
  
  return {
    name: fileData.name,
    filename: filename,
    path: `/uploads/customField/${filename}`,
    size: fileData.size,
    mimetype: mimeType,
  };
};