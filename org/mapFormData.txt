const mapFormData = (values) => {
  // Kiểm tra xem có file trong customField không
  const hasCustomFieldFiles = values.customField && 
    Object.values(values.customField).some(v => 
      typeof v === 'string' && v.startsWith('data:')
    );

  // Nếu KHÔNG có file, trả về object thông thường
  if (!hasCustomFieldFiles) {
    return {
      ...values,
      customField: values.customField ? normalizeCustomFieldForSave(values.customField) : []
    };
  }

  // Nếu CÓ file, dùng FormData
  const formData = new FormData();
  
  Object.keys(values).forEach((key) => {
    if (key === 'customField') {
      const customFieldObj = values.customField || {};
      const customFieldArray = [];
      const filesToUpload = {};

      Object.entries(customFieldObj)
        .filter(([_, v]) => v !== undefined && v !== null && v !== '')
        .forEach(([name, value]) => {
          // Date
          if (moment.isMoment(value)) {
            customFieldArray.push({ name, value: value.format('YYYY-MM-DD') });
            return;
          }
          // Boolean
          if (typeof value === 'boolean') {
            customFieldArray.push({ name, value: value ? '1' : '0' });
            return;
          }
          // Number
          if (typeof value === 'number') {
            customFieldArray.push({ name, value: String(value) });
            return;
          }
          // Base64 file (new upload)
          if (typeof value === 'string' && value.startsWith('data:')) {
            customFieldArray.push({ name, value: '__FILE_UPLOADED__' });
            filesToUpload[name] = value;
            return;
          }
          // Existing file path
          if (typeof value === 'string' && value.startsWith('/uploads')) {
            customFieldArray.push({ name, value });
            return;
          }
          // String/other
          customFieldArray.push({ name, value: String(value) });
        });

      if (customFieldArray.length > 0) {
        formData.append('customField', JSON.stringify(customFieldArray));
      }

      // Append file blobs
      Object.entries(filesToUpload).forEach(([name, base64]) => {
        const contentType = base64.split(';')[0].split(':')[1];
        const blob = base64ToBlob(base64, contentType);
        const ext = contentType.split('/')[1];
        formData.append(`customFieldFile_${name}`, blob, `${name}.${ext}`);
      });
    } else if (values[key]) {
      formData.append(key, values[key]);
    }
  });

  return formData;
};