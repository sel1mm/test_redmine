
const CUSTOM_FIELD_MAP = {
  testBoolean: 'Test Boolean',
  testDate: 'Test Date',
  testInteger: 'Test Integer',
  testFloat: 'Test Float',
  testFile: 'Test File',
  testKeyValueList: 'Test Key Value List',
  testLink: 'Test Link',
  testList: 'Test List',
  testText: 'Test Text',
  testProgressBar: 'Test Progress Bar',
  testString: 'Test String',
  testUser: 'Test User',
  testVersion: 'Test Version',
};


module.exports = (req, res, next) => {
  const { customField } = req.body;

  if (!customField || typeof customField !== 'object') {
    return next();
  }

  const customFieldArray = Object.entries(customField)
    .filter(([_, value]) => value !== undefined && value !== null && value !== '')
    .map(([key, value]) => ({
      name: CUSTOM_FIELD_MAP[key] || key,
      value: String(value),
    }));

  req.body.customField = customFieldArray;

  next();
};

customField: Joi.array()
  .items(
    Joi.object({
      name: Joi.string().required(),
      value: Joi.any().allow(null, ''),
    })
  )
  .optional(),

const handleFinishSubmission = async () => {
  try {
    const fieldsValue = await form.validateFields();

    const customFieldObject = fieldsValue.customField || {};

    const customFieldArray = Object.entries(customFieldObject)
      .filter(([_, v]) => v !== undefined && v !== null && v !== '')
      .map(([name, value]) => {
        // Date
        if (moment.isMoment(value)) {
          return { name, value: value.format('YYYY-MM-DD') };
        }

        // Boolean
        if (typeof value === 'boolean') {
          return { name, value: value ? '1' : '0' };
        }

        // Number
        if (typeof value === 'number') {
          return { name, value: String(value) };
        }

        return { name, value: String(value) };
      });

    const payload = {
      ...fieldsValue,
      customField: customFieldArray,
      dateOfBirth: fieldsValue.dateOfBirth?.format('YYYY-MM-DD') || null,
      hireDate: fieldsValue.hireDate?.format('YYYY-MM-DD') || null,
      endDate: fieldsValue.endDate?.format('YYYY-MM-DD') || null,
      skills: fieldsValue.skills || [],
    };

    onSubmit({
      ...(modalEmployeeData?.id ? { id: modalEmployeeData.id } : {}),
      ...payload,
    });

    setIsDirty(false);
  } catch (e) {
    console.log('error', e);
  }
};


<Form.Item
  label={field.name}
  name={['customField', field.name]}
  valuePropName="checked"
  initialValue={false}
>
  <Checkbox />
</Form.Item>



const mapCustomFieldToObject = (customField) => {
  const result = {};

  // Case 1: null / undefined
  if (!customField) return result;

  // Case 2: backend trả OBJECT (JSONB)
  if (
    typeof customField === 'object' &&
    !Array.isArray(customField)
  ) {
    Object.entries(customField).forEach(([name, value]) => {
      result[name] = normalizeCustomFieldValue(value);
    });
    return result;
  }

  // Case 3: backend trả ARRAY
  if (Array.isArray(customField)) {
    customField.forEach(({ name, value }) => {
      if (!name) return;
      result[name] = normalizeCustomFieldValue(value);
    });
  }

  return result;
};



const normalizeCustomFieldValue = (value) => {
  if (value === '1' || value === '0') {
    return value === '1';
  }

  if (typeof value === 'number') {
    return value;
  }

  if (!isNaN(value) && value !== '') {
    return Number(value);
  }

  if (
    typeof value === 'string' &&
    moment(value, 'YYYY-MM-DD', true).isValid()
  ) {
    return moment(value);
  }

  return value;
};


import React, { useEffect, useState } from 'react';
import { Collapse, Descriptions, Row } from 'antd';
import { useIntl } from '@toolchain/hook';
import { IconAtnd } from '@toolchain/component';
import get from 'lodash/get';
import moment from 'moment';
import fieldConfig from '../ModalDetails/FormData/CustomizeField.json';
import { dateFormat } from '../constants';

const { Panel } = Collapse;

// ✅ Thêm 2 hàm helper
const normalizeCustomFieldValue = (value) => {
  if (value === '1' || value === '0') {
    return value === '1';
  }
  if (typeof value === 'number') {
    return value;
  }
  if (!isNaN(value) && value !== '') {
    return Number(value);
  }
  if (
    typeof value === 'string' &&
    moment(value, 'YYYY-MM-DD', true).isValid()
  ) {
    return moment(value);
  }
  return value;
};

const mapCustomFieldToObject = (customField) => {
  const result = {};
  // Case 1: null / undefined
  if (!customField) return result;
  // Case 2: backend trả OBJECT (JSONB)
  if (
    typeof customField === 'object' &&
    !Array.isArray(customField)
  ) {
    Object.entries(customField).forEach(([name, value]) => {
      result[name] = normalizeCustomFieldValue(value);
    });
    return result;
  }
  // Case 3: backend trả ARRAY
  if (Array.isArray(customField)) {
    customField.forEach(({ name, value }) => {
      if (!name) return;
      result[name] = normalizeCustomFieldValue(value);
    });
  }
  return result;
};

function CustomizeFieldDetail({ detail = {} }) {
    const { formatMessage } = useIntl();
    
    // ✅ Xử lý customField data
    const customFieldData = mapCustomFieldToObject(detail?.customField);

    const renderFieldValue = (field) => {
        // ✅ Lấy value từ customFieldData đã được normalize
        const value = customFieldData[field.name];

        // Nếu không có giá trị
        if (!value && value !== 0 && value !== false) {
            return '---';
        }

        // Xử lý theo từng loại field
        switch (field.field_format) {
            case 'string':
            case 'text':
            case 'link':
                return value || '---';

            case 'int':
            case 'float':
            case 'progressbar':
                return value !== undefined && value !== null ? value : '---';

            case 'date':
                // ✅ value đã là moment object từ normalizeCustomFieldValue
                return moment.isMoment(value) 
                    ? value.format(dateFormat) 
                    : (value ? moment(value).format(dateFormat) : '---');

            case 'bool':
                return value ? formatMessage({ id: 'app.yes', defaultMessage: 'Yes' }) 
                             : formatMessage({ id: 'app.no', defaultMessage: 'No' });

            case 'list':
            case 'version':
                return Array.isArray(value) ? value.join(', ') : value || '---';

            case 'user':
                if (Array.isArray(value)) {
                    return value.map(user => user.name || user).join(', ') || '---';
                }
                return value?.name || value || '---';

            case 'enumeration':
                // Tìm tên tương ứng với id
                const enumItem = field.possible_values?.find(item => item.id === value);
                return enumItem?.name || value || '---';

            case 'attachment':
                if (Array.isArray(value)) {
                    return value.map(file => file.name || file).join(', ') || '---';
                }
                return value?.name || value || '---';

            default:
                return value || '---';
        }
    };

    // Chia fields thành các nhóm 3 (để hiển thị trên 1 row)
    const fieldsToDisplay = fieldConfig.filter(field => {
        // Có thể thêm logic để chỉ hiển thị fields có giá trị
        return true; // Hiển thị tất cả fields
    });

    return (
        <Collapse
            defaultActiveKey={['customize']}
            className="rounded-collapse"
            style={{ marginTop: 16 }}
            expandIcon={({ isActive }) =>
                isActive ? (
                    <IconAtnd size={24} type="UpCircleOutlined" />
                ) : (
                    <IconAtnd size={24} type="DownCircleOutlined" />
                )
            }
        >
            <Panel
                header={formatMessage({
                    id: 'hrm.employee.detail.customize.information',
                    defaultMessage: 'Customize Information',
                })}
                key="customize"
                collapsible="header"
            >
                <Row className="sector-input-group">
                    <Descriptions
                        labelStyle={{ width: 200 }}
                        contentStyle={{ width: 200 }}
                        column={{ xs: 1, lg: 3 }}
                        bordered
                        style={{ width: '100%' }}
                    >
                        {fieldsToDisplay.map((field) => (
                            <Descriptions.Item
                                key={field.id}
                                label={field.name}
                            >
                                {renderFieldValue(field)}
                            </Descriptions.Item>
                        ))}
                        
                        {/* Thêm các item rỗng để căn chỉnh layout nếu số field không chia hết cho 3 */}
                        {fieldsToDisplay.length % 3 !== 0 && (
                            Array.from({ length: 3 - (fieldsToDisplay.length % 3) }).map((_, index) => (
                                <Descriptions.Item key={`empty-${index}`} label="">
                                    {''}
                                </Descriptions.Item>
                            ))
                        )}
                    </Descriptions>
                </Row>
            </Panel>
        </Collapse>
    );
}

export default CustomizeFieldDetail;

